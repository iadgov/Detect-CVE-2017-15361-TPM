Set-StrictMode -Version 2

Function Test-CVE201715361TPM  {
    <#
    .SYNOPSIS
    Tests if a system has an enabled TPM that is vulnerable to CVE-2017-15361.

    .DESCRIPTION
    Tests if a system has an enabled TPM that is vulnerable to CVE-2017-15361.

    .EXAMPLE
    Test-CVE201715361TPM 
    #>
    [CmdletBinding()]
    Param()

    $vulnerable = $false

    try {
        $vulnerable = @(Get-WinEvent -FilterHashTable @{ProviderName='Microsoft-Windows-TPM-WMI';Id=1794;Level=2} -ErrorAction SilentlyContinue).Count -gt 0
    } catch {}

    if (!$vulnerable) {
        $tpm = $null

        try {
            $tpm = Get-WmiObject -Class 'Win32_TPM' -Namespace 'root/cimv2/Security/MicrosoftTPM' -ErrorAction SilentlyContinue
        } catch {}

        if ($tpm -ne $null) {
            if($tpm.ManufacturerId -eq 0x49465800) {
                if ($tpm.ManufacturerVersion.Length -ge 3) {
                    $version = [System.Version]$tpm.ManufacturerVersion

                    switch ($version.Major) {
                        4 {$vulnerable = ($version.Minor -le 33 -or @(40..42) -contains $version.Minor);break}
                        5 {$vulnerable = ($version.Minor -le 61);break}
                        6 {$vulnerable = ($version.Minor -le 42);break}
                        7 {$vulnerable = ($version.Minor -le 61);break}
                        133 {$vulnerable = ($version.Minor -le 32);break}
                        default {$vulnerable = $false;break}  
                    }
                }
            } 
        }
    }
    $vulnerable
}